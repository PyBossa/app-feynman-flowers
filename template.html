<style type="text/css">
    #throbber {
        padding: 10px;
        position:absolute;
        left: 45%;
        top:45%;
        margin: -50px 0 0 -50px;
        z-index: 10000;
        width: 100px;
        height: 100px;
    }

#layer0 {
        position: relative;
    }

#layer1 {
    z-index: 1;
        border: 1px solid rgb(0, 0, 0.1);
        box-shadow: 0 0 5px #888;

}

#layer2 {
    text-align: center;
    position: absolute;
    overflow: hidden;
    top: 0;
    left: 0;
    opacity: 0;
    //background-color: rgba(51,51,51, 0.7);
    z-index: 999;
    transition: all 0.4s ease-in-out;
    }

#layer2 {
    text-align: center;
    position: absolute;
    overflow: hidden;
    top: 0;
    left: 0;
    opacity: 1;
    //background-color: rgba(51,51,51, 0.7);
    z-index: 999;
    transition: all 0.4s ease-in-out;
    }

#layer3 {
    text-align: center;
    position: absolute;
    overflow: hidden;
    top: 0;
    left: 0;
    opacity: 1;
    //background-color: rgba(51,51,51, 0.7);
    z-index: 9999;
    transition: all 0.4s ease-in-out;
    }



</style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <!-- Question, task id, photo and action buttons for answering the question-->
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
        <strong>The task has been completed!</strong> Thanks a lot!</strong>
</div>

<div id="finish" class="alert alert-success" style="display:none;">
    <strong>Congratulations!</strong> You have participated in all available tasks!</strong>
<br/>
<div class="alert-actions">
    <a class="btn small" href="/">Go back</a>
    <a class="btn small" href="/app">or, Check other applications</a>
</div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
<a class="close">×</a>
<strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
  </div> <!-- End Success and Error Messages for the user -->
</div>


<div id="throbber"></div>

<div class="row skeleton">
  <div id="question" class="span5 well">
      <h2>Question</h2>
      <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
      <p>You have completed: <span id="done" class="label label-info"></span> tasks from
      <span id="total" class="label label-inverse"></span></p>
      <div class="progress progress-striped">
          <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
      </div>
      <p><span class="label label-warning"><i class="icon-bullhorn"></i> Tip</span> If you need help, check the <a class="btn btn-primary" href="../tutorial">Tutorial</a></p>
      <p>Molecule <strong>X</strong> and <strong>Y</strong> coordinates: <span id="molecule-x" class="label label-info">0</span> <span id="molecule-y" class="label label-info">0</span></p>
      <div id="rotation-box" class="row" style="display:none">
        <hr>
        <div class="span2">
          <strong>Degrees</strong> <span class="badge badge-info" id="rotation">0º</span>
        </div>
        <div class="span2">
          <div class="btn-group">
            <button class="btn" onclick="increaseDegrees()"><i class="icon icon-white icon-plus"></i></button>
            <button id="rotation-btn" rel="tooltip" title="Use these buttons to increase/decrease the degrees" class="btn" onclick="decreaseDegrees()"><i class="icon icon-white icon-minus"></i></button>
          </div>
        </div>
      </div>
      <!-- Answer buttons -->
      <div id="answer" class="span5" style="display:none; padding-top:10px;text-align:center;">
          <hr>
          <button class="btn btn-large btn-success" onclick="submitTask()"><i class="icon icon-white icon-ok"></i> Save the coordinates and the angle</button>
      </div>

  </div>
  <div id="layer0" class="span6">
      <div id="layer1" style="width:512px;height:512px;">
        <a id="photo-link" href="#">
            <img id="photo" src="http://img339.imageshack.us/img339/9017/loadingo.png" onload="spinnerStop()" style="max-width=100%">
            </a>
      </div>
      <div id="layer2" style="width:512px;height:512px;">
      </div>
      <div id="layer3" style="">
      </div>
  </div>
</div>

<div class="row skeleton">
</div>



<script src="/static/js/raphael-min.js" type="text/javascript"></script>
<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script src="/static/js/throbber/throbber.js" type="text/javascript"></script>
<script>
var spinner = new Throbber({
    color: 'black',
    size: 90
});

var degrees = 0;
var photo;
var molecule_label;
// The spinner is attached to a div overlayed in top of the photo. 
// This div is only shown when the spinner is active, 
// otherwise, the div is hidden from the view to show the photo.¬

spinner.appendTo (document.getElementById('throbber'));

// This function shows the spinner div and starts its animation¬
function spinnerStart() {
    $("#throbber").show();
    spinner.start();
    console.log("Spinner started!");
}

// This function stops the spinner and hides the spinner div¬
function spinnerStop() {
    spinner.stop()
    $("#throbber").hide();
    console.log("Spinner stopped!");
}

var crosshairpaper;
var set; 
var mol_x=0;
var mol_y=0;

function increaseDegrees() {

    degrees = parseInt($("#rotation").text(),10);
    degrees += 1;
    $("#rotation").text(degrees + "º");
    set.transform("r" + degrees + ","+mol_x+","+mol_y);
}

function decreaseDegrees() {

    degrees = parseInt($("#rotation").text(),10);
    degrees -= 1;
    $("#rotation").text(degrees + "º");
    set.transform("r" + degrees + ","+mol_x+","+mol_y);
}

function activateCrosshair() {

}

// Crosshair for the molecules
function initializeCrosshair(div,posX, posY, size){
    var pause = false;
    var pauseAngle = false;
    crosshairpaper = Raphael(document.getElementById(div), size, size);
    set = crosshairpaper.set();
    
    $('svg').attr("cursor","crosshair");
    
    halfSize = size/2;

    size = size * 100;

    halfSize = size/2;
    
    set.push(
        crosshairpaper.path("M0 "+halfSize+"H"+size).attr("stroke","cyan"),
        crosshairpaper.path("M"+halfSize+" 0V"+size).attr("stroke","cyan")
    );
    
     $('svg').mousemove(function(e){  
         if (!pause) {
          set.remove()
    
          var LineXPos = (e.pageX-posX);
          var LineYPos = (e.pageY-posY);
          
          set.push(
          crosshairpaper.path("M0 "+LineYPos+"H"+size).attr("stroke","cyan"),
          crosshairpaper.path("M"+LineXPos+" 0V"+size).attr("stroke","cyan")
          );
          mol_x = e.pageX-posX;
          mol_y = e.pageY-posY;
          $("#molecule-x").text(mol_x);
          $("#molecule-y").text(mol_y);
          set.transform("r"+degrees+" "+mol_x+" "+mol_y);
        } else {
        
	        if(!pauseAngle){
		        X = parseInt($("#molecule-x").text());
		        Y = parseInt($("#molecule-y").text());
		        
		        degrees  = Raphael.angle((e.pageX-posX), (e.pageY-posY),X,Y);
			    set.transform("r"+degrees+" "+X+" "+Y);
			    $('svg').attr("cursor","move");	
			    $("#rotation").text(parseInt(degrees,10)+"°");
		    }else{
			   $('svg').attr("cursor","default");	 
		    }
		 }	

        

          
        });
    
     $('svg').click(function(e){
        $("#molecule-x").text(e.pageX-posX);
        $("#molecule-y").text(e.pageY-posY);
        
        //Raphael.isPointInsideBBox(Raphael.getElementById(), e.pageX-posX, e.pageY-posY)
        
        if (!pause) {
            pause = true;
        }
        else {
        	if(!pauseAngle){
	        	pauseAngle= true;
        	}
        	else{
        		pauseAngle = false;
        		pause = false;
            }
        }
       
        $("#rotation-box").show();
        $("#answer").show();
        $("#rotation-btn").tooltip({'trigger': 'manual', 'placement': 'right'}); 
        $("#rotation-btn").tooltip('show');
        $("#rotation-btn").bind('hover',function(){
            $("#rotation-btn").tooltip('hide');
        });

        degrees = parseInt($("#rotation").text(),10);
      });
}


// Function to load the TaskRun data into the HTML skeleton
function loadData( data ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    if ( !$.isEmptyObject(data.task) ) {
        spinnerStart();
        console.log(data.task);
        $("#question h2").text(data.question);
        $("#task-id").text(data.task.id);
        $("#photo-link").attr("href", data.task.info.url_photo);
        $("#photo").attr("src",data.task.info.url_photo);
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
}

function loadTask( task_id ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    var t = $.ajax({
        url: '/api/task/'+task_id,
        dataType: 'json'
    });
    t.done( function (task) {
        if ( !$.isEmptyObject(task) ) {
            spinnerStart();
            if (task.state=='completed') {
                $('#answer').hide();
                $('#disqus_thread').hide();
                $('#taskcompleted').show();
            }
            loadUserProgress();
            $("#question h2").text(task.info.question);
            $("#task-id").text(task.id);
            $("#photo-link").attr("href", task.info.url_photo);
            $("#photo").attr("src", task.info.url_photo);
            photo = task.info.url_photo;
            molecule_label = task.info.molecule_label;

            var bboxpaper = Raphael(document.getElementById('layer2'), 512, 512);

            // This should be uncommented when we clear out the data format of bbox
            //for(i=0;i<task.info.bbox.length;i++) {
            for(i=0;i<1;i++) {
                var rect = bboxpaper.rect(task.info.bbox[i].x,task.info.bbox[i].y,task.info.bbox[i].width,task.info.bbox[i].height);
                
                // Sets the stroke attribute of the rect
                rect.attr("stroke", "cyan");
            }

            // load the CrossHair
            //initializeCrosshair($("#layer3").offset().left,$("#layer3").offset().top,512);
            posX = $("#layer3").offset().left;
            posY = $("#layer3").offset().top;
            initializeCrosshair("layer3", $("#layer3").offset().left,$("#layer3").offset().top,512);
            //$("#layer1").css('-webkit-transform','rotate(30deg)'); 
            //$("#layer1").css('-webkit-transform-origin','50% 50%;');
            //$("#layer2").css('-webkit-transform','rotate(30deg)'); 
            //$("#layer2").css('-webkit-transform-origin','50% 50%;');
            //$("#layer3").css('-webkit-transform','rotate(30deg)'); 
            //$("#layer3").css('-webkit-transform-origin','50% 50%;');

        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}

function loadUserProgress() {
    pybossa.userProgress('feynmanflowers').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'bottom'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

// Function to submit and save the TaskRun in PyBossa
function submitTask() {
    // Get the task-id
    var taskid = $("#task-id").text();
    // Get coordinates:
    var answer = {"photo": photo, "molecule_label": molecule_label, "x": mol_x, "y": mol_y, "angle": degrees}
    // Save the task
    pybossa.saveTask(taskid, answer).done( function( data ) {
        // Uncoment next line for debugging purposes
        //console.log("Answer saved!");
        // FadeIn & Out the success div feedback
        $("#success").fadeIn();
        setTimeout(function() { $("#success").fadeOut() }, 2000);
        // Load a new task
        //pybossa.newTask("feynmanflowers").done( function( data ){ loadData( data ) });
        window.location.pathname = "/app/feynmanflowers/newtask";
    });
}

// Check if the user is loading directly a task or requesting a new one
var taskId = pybossa.getCurrentTaskId(window.location.pathname);

if (taskId){
    // The user is loading directly a task, so load then input data
    loadTask(taskId);
}
else {
    // The user is requesting a new task, so get a new one
    pybossa.newTask("feynmanflowers").done( function( data ) { 

        if ( !$.isEmptyObject(data.task) ) {
            window.location.pathname = "/app/feynmanflowers/task/" + data.task.id;
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}
</script>
